TODO

Tests for  scingestor/beamtimeWatcher.py:
-----------------------------------------

- WRONG path if check for errors in _find_bt_files() needed ?? disk error e.g. os.path.isdir("\0")  (NO EXEC ????)


- WRONG _add_path of add_watch() exception ???? REMOVE ????

- _add_base_path(self, path, split=True) when split base_path needed   ????
- WHEN no path in _add_base_path(self, path, split=True) when split ??

- EXCEPTION in _add_base_path ???? if needed ????



- WRONG in start() when len(self.__wd_to_queue) == 0 ????

- WRONG in start() when len(self.__wd_to_bqueue) == 0 ????

- WRONG in start() "not self.__beamtime_base_dir"  ??????

- WRONG in start() "not event.name"  ??????

- WRONG in start() " if not os.path.isfile(fl)" ????
- WRONG in start()  " while len(dss):" ????




Tests for  scingestor/datasetIngest.py
--------------------------------------

- WRONG in start() Exception  ????

- WRONG in _ingest_scandir, Exception ?????

- WRONG path if check for errors in _find_bt_files() needed ?? disk error e.g. os.path.isdir("\0")  (NO EXEC ????)


Tests for  scingestor/datasetIngestor.py
----------------------------------------

- in _generate_rawdataset_metadata()  if not self.__ext and not self.__logcommands tests ??

- in _generate_rawdataset_metadata()  no rdss generated  tests ??

- in _generate_origdatablock_metadata(self, scan) no obds generated  tests ??

- in _regenerate_origdatablock_metadata(...) if  open(mfilename, "r") not loadable tests?
-   in _regenerate_origdatablock_metadata(...) if dmeta is None ???

- in _regenerate_origdatablock_metadata(...) if dmeta  and  not self.__logcommands tests ??

- in _regenerate_origdatablock_metadata(...) if  new metad not loadable tests?

- in _regenerate_origdatablock_metadata()  no obds generated  tests ??

- in _metadataEqual(...) if parent tests ?

- in _metadataEqual(...) if k not in dct2.keys()  tests ?

- in _metadataEqual(...) if isinstance(v, dict)  tests ?

- in get_token(self) request exception test e.g. content without id ??

- in get_token(self) exception test if not response.ok ??

- in append_proposal_groups(self) request exception test e.g. content without exists ??

- in append_proposal_groups(self) exception test if not resget.ok ??

- in post_dataset(...) exception test if spid[-1] not int ??

- in post_dataset(...) exception test if not resexists.ok ??

- in post_dataset(...) exception test if not response.ok ??

- in patch_dataset(...) exception test if not response.ok ??

- in _ingest_dataset(...) exception test if not resexists.ok ??

- in _ingest_dataset(...) if  resexists exception test e.g. content without exists ?

- in _ingest_dataset(...) exception test if not response.ok ??

- in _ingest_dataset(...) exception test if not resds.ok ??

- in _ingest_dataset(...) exception test if not resexists.ok  (second) ??

- in _ingest_dataset(...) exception test if request EXCEPTIONS ?????

- in _ingest_origdatablock(...) exception test if not response.ok ??

- in _ingest_origdatablock(...) exception test if request EXCEPTIONS ?????

- in _ingest_attachment(...) exception test if not response.ok ??

- in _ingest_attachment(...) exception test if request EXCEPTIONS ?????

- in _get_id_first_origdatablock(...) exception test if request EXCEPTIONS ?????

- in _get_delete_origdatablock(...) exception test if not response.ok ??

- in _get_delete_origdatablock(...) exception test if request EXCEPTIONS ?????

- in _get_pid(...) exception test if metedata is not loadable ??

- in _ingest_rawdataset_metadata() if mt["proposalId"] != self.__bid error (wrong beamtime)

- in _ingest_rawdataset_metadata() if not mt["pid"].startswith("%s/" % (self.__bid)) (wrong beamtime)
-  in _ingest_rawdataset_metadata() exception test if metedata is not loadable ??

- _delete_origdatablocks() duplicated origdatablocks to delete test ?

- _delete_origdatablocks() exception test if request EXCEPTIONS ?????

- _ingest_origdatablock_metadata()  if not mt["datasetId"].startswith(
                    "%s/%s/" % (self.__pidprefix, self.__bid)) EXCEPTIONS tests ?

- in _ingest_origdatablock_metadata() exception test if request EXCEPTIONS ?????

- in _ingest_attachment_metadata() if "datasetId" in mt and ..
                                       : EXCEPTIONS tests ?

- in ingest() if  odbs[0] (first) tests

- in ingest() if  pid is None and rdss and rdss[0]: tests?

- in ingest()  if self.__ingest_attachment and ads and ads[0] and pid:
                if pid is None and adss and adss[0]: tests ?

- in ingest() if  pid is None: tests?
- in ingest() if  dbstatus is None : tests?

- in reingest() if self.__ingest_attachment:  tests
- in reingest() if self.__ingest_attachment (second):  tests

- in reingest()   else:  mtmds = 0    tests

- in reingest()   else:  mtmdb = 0    tests

- in reingest()   if (dastatus and reingest_attachment):   tests

- in check_list()  if reingest and Exception test ???




Tests for  scingestor/datasetWatcher.py
---------------------------------------

- in _add_path() EXCEPTION of add_watch() exception ???? REMOVE ????


- in run() EXCEPTION from self.__ingestor.check_list()  tests ??

- in run() EXCEPTION from self.__ingestor.ingest(scan, token)  tests ??

- in run() if event.name: and "IN_CLOSE_WRITE test ??

- in run() EXCEPTION from self.__ingestor.check_list() in the loop  tests ??

- in run() loop if event.name: and  "IN_MODIFY" in masks or "IN_OPEN" in masks test ??

- in run() loop if EXCEPTION from self.__ingestor.check_list() in the loop if self.__recheck_dslist_interval > 0 tests  ??

- in run() loop get_token EXCEPTION test ??

- in run() loop self.__ingestor.ingest(scan, token) EXCEPTION test ??



Tests for  scingestor/modelIngest.py
-------------------------------------

- model metadata not loadable tests ,  _ingest_model_metadata(self, metafile, token)

- in _ingest_model(self, metadata, token) if not response.ok tests

- in get_token  if not request.ok tests

- in get_token  request exception test e.g. content without id ??


Tests for  scingestor/pathConverter.py
--------------------------------------

- in to_core if path in self.__notify_core_path.keys() tests   (SEP)

Tests for  scingestor/safeINotifier.py
--------------------------------------

- in run  os.close(self.__notifier) exception ????


Tests for  scingestor/scanDirWatcher.py
---------------------------------------

- EXCEPTION in _add_path ???? if needed ????

- WRONG in   _launch_scandir_watcher(self, paths) exception ????

- WRONG in run() when (not self.__wd_to_queue) ????

- in run() if self.__dslist_fullname == npath and \
                                   not os.path.isfile(self.__dslist_fullname) \
                                   and os.path.isdir(self.__path)
    , watcher for subdirectories launched tests ??


- in run() if fn not in self.__dataset_watchers.keys() \
                                   and fn == self.__dslist_fullname:

   ,tests ??

-     in run() if dw is not None: tests?

- in run() if list(self.__scandir_watchers.keys()) and "IN_ISDIR" not in masks tests
    ...



DONE

Name                            Stmts   Miss  Cover   Missing
-------------------------------------------------------------
scingestor/__init__.py              1      0   100%
scingestor/beamtimeWatcher.py     358     29    92%   221-222, 263-265, 280, 283, 299-302, 360-361, 453-454, 470-476, 483, 512-514, 516-520
scingestor/configuration.py        10      0   100%
scingestor/datasetIngest.py       156      5    97%   256, 271-272, 292-293
scingestor/datasetIngestor.py     833    122    85%   655, 665, 697, 769-770, 772-780, 795, 804-806, 824, 857, 864-868, 870-872, 896-900, 924, 948-953, 977-981, 997, 1014, 1045, 1076-1079, 1081, 1086-1087, 1099, 1137-1143, 1165-1169, 1196-1200, 1223-1224, 1246-1250, 1266-1267, 1287, 1291, 1297-1298, 1320, 1322-1323, 1343, 1354-1357, 1374-1383, 1388-1391, 1426, 1455, 1460, 1464, 1466, 1563-1592, 1617-1623, 1631, 1637, 1640, 1680-1681, 1700
scingestor/datasetWatcher.py      152     31    80%   155-156, 175-176, 192-193, 202, 221-223, 232-234, 237-249, 264-266, 280-282, 286-288
scingestor/logger.py               36      0   100%
scingestor/modelIngest.py          98      9    91%   143-146, 165-166, 181-185
scingestor/pathConverter.py        30      1    97%   61
scingestor/safeINotifier.py       102      2    98%   229-230
scingestor/scanDirWatcher.py      184     24    87%   197-198, 240-241, 283, 311-318, 329-337, 343-344, 351-357, 359-360
-------------------------------------------------------------
TOTAL                            1960    223    89%
